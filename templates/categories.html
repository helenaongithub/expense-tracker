{% extends "base.html" %}
{% block content %}
<style>
.category-card { min-height: 120px; display:flex; flex-direction:column; }
.category-header { display:flex; align-items:center; gap:0.6rem; padding:0.6rem 0.9rem; }
.category-emoji {
  width:42px; height:42px; display:inline-flex; align-items:center; justify-content:center;
  font-size:1.35rem; border-radius:8px; cursor:pointer; user-select:none;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.03);
}
.category-name { flex:1; font-weight:600; font-size:1rem; color:var(--bs-white); cursor:text; }
.category-name-input { width:100%; box-sizing:border-box; }

.category-actions { display:flex; gap:0.35rem; align-items:center; min-width:0; }
.category-body { padding:0.65rem 0.9rem; flex:1; display:flex; flex-direction:column; gap:0.5rem; }

.badge-keyword { font-size:0.78rem; padding:0.35rem 0.6rem; border-radius: 0.6rem; }

.small-action-btn { padding:0.28rem 0.45rem; font-size:0.85rem; }

.card .card-header { background: transparent; border-bottom: none; padding-bottom:0.2rem; }
.card { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.06); }

/* reduce whitespace on small screens */
@media (max-width: 575px) {
  .category-emoji { width:36px; height:36px; font-size:1.05rem; }
  .category-name { font-size:0.95rem; }
}
</style>

<h3 class="mb-3">Categories</h3>

<!-- Add category -->
<form method="post" action="{{ url_for('add_category') }}" class="row g-2 align-items-center mb-3">
  <div class="col-sm-6 col-md-5">
    <input name="name" class="form-control" placeholder="New category name" required>
  </div>

  <div class="col-auto">
    <div class="input-group" style="width:140px;">
      <input id="add-emoji" name="emoji" class="form-control" placeholder="Emoji" style="min-width:64px;">
      <button type="button" class="btn btn-outline-secondary" title="Pick emoji" onclick="openEmojiPanel('#add-emoji')">😊</button>
    </div>
  </div>

  <div class="col-auto">
    <button class="btn btn-primary">Add category</button>
  </div>
</form>

<div class="row gy-3">
  {% for c in categories %}
  <div class="col-md-4">
    <div class="card category-card h-100">
      <!-- header: emoji, name (click-to-edit), actions -->
      <div class="card-header category-header">
        <div title="Click to change emoji"
             class="category-emoji"
             id="emoji-display-{{ c.id }}"
             onclick="openEmojiPanel('#emoji-input-{{ c.id }}')">
          {{ c.emoji or '🗂️' }}
        </div>

        <div class="category-name-wrap" style="min-width:0;">
          <!-- display mode -->
          <div class="category-name" id="name-display-{{ c.id }}" onclick="enterEdit({{ c.id|tojson }})">
            {{ c.name }}
          </div>
          <!-- edit mode (hidden unless editing) -->
          <input type="text" id="name-input-{{ c.id }}" class="form-control form-control-sm category-name-input"
                 style="display:none;" value="{{ c.name }}" maxlength="64" />
        </div>

        <div class="category-actions">
          <!-- Save / Cancel (appear when editing) -->
          <button type="button" class="btn btn-success btn-sm small-action-btn" id="save-btn-{{ c.id }}" style="display:none;"
                  title="Save" onclick="saveEdit({{ c.id|tojson }})">✓</button>
          <button type="button" class="btn btn-outline-secondary btn-sm small-action-btn" id="cancel-btn-{{ c.id }}" style="display:none;"
                  title="Cancel" onclick="cancelEdit({{ c.id|tojson }})">✖</button>

          <!-- inline edit emoji input (hidden) - used by emoji panel target -->
          <input type="hidden" id="emoji-input-{{ c.id }}" name="emoji" value="{{ c.emoji or '' }}">

          {# Place delete button at the far right of header by using margin-left:auto on its wrapper #}
          <div style="margin-left:auto;">
            <form id="delete-form-category-{{ c.id }}" method="post" action="{{ url_for('delete_category', cat_id=c.id) }}" style="display:inline;">
              <button type="button" class="btn btn-sm btn-outline-danger small-action-btn delete-btn"
                      data-form-id="delete-form-category-{{ c.id }}"
                      data-item="Category '{{ c.name }}' and all its keywords">🗑️</button>
            </form>
          </div>
        </div>
      </div>

      <div class="card-body category-body">
        <div>
          <div class="small text-muted mb-1">Keywords</div>
          <div>
            {% if c.keywords %}
              {% for kw in c.keywords %}
                <span class="badge bg-secondary me-1 mb-1 badge-keyword d-inline-flex align-items-center">
                  {{ kw.keyword }}
                  <form id="{{ 'delete-form-keyword-' ~ kw.id }}"
                        method="post"
                        action="{{ url_for('delete_keyword', kw_id=kw.id) }}"
                        style="display:inline; margin-left:0.5rem;">
                    <button type="button"
                            class="btn btn-close btn-close-white btn-sm ms-2 delete-btn"
                            aria-label="Remove"
                            data-form-id="{{ 'delete-form-keyword-' ~ kw.id }}"
                            data-item="Keyword '{{ kw.keyword }}' from category '{{ c.name }}'"></button>
                  </form>
                </span>
              {% endfor %}
            {% else %}
              <div class="text-muted small">No keywords</div>
            {% endif %}
          </div>
        </div>

        <div class="mt-auto d-flex justify-content-between align-items-center">
          <div class="small text-muted">ID: {{ c.id }}</div>
          <div class="d-flex gap-2">
            <a class="btn btn-sm btn-outline-light"
               href="{{ url_for('index', time='total', search_id='', search_amount='', search_desc='', search_cate=c.name, order='date') }}">Show</a>

            <button type="button"
                    class="btn btn-sm btn-outline-secondary add-keyword-btn"
                    data-catid="{{ c.id }}"
                    data-catname="{{ c.name|e }}">
              Add keyword
            </button>

          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Keyword modal -->
<div class="modal fade" id="keywordModal" tabindex="-1" aria-labelledby="keywordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="keywordModalLabel">Add keyword</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="keyword-form" method="post" action="">
        <div class="modal-body">
          <div id="keyword-modal-category" class="mb-2"></div>
          <div class="mb-2">
            <input id="keyword-input" name="keyword" class="form-control" placeholder="Keyword">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ========== global emoji panel ========= #}
<div id="emoji-panel" class="card p-2 shadow" style="position:fixed;right:18px;bottom:18px;max-width:360px;display:none;z-index:3000;">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <strong class="small">Pick an emoji</strong>
    <div>
      <button id="emoji-panel-close" type="button" class="btn btn-sm btn-outline-secondary">Close</button>
    </div>
  </div>

  <div class="mb-2">
    <input id="emoji-search" class="form-control form-control-sm" placeholder="Filter (emoji or name)">
  </div>

  <div id="emoji-list" class="d-flex flex-wrap" style="gap:6px;max-height:40vh;overflow:auto;">
    {% set emoji_list = [
      "💰","💸","💵","💳","🏦","💼","💲",
      "🛒","🍰","🍽️","🍔","🍷","🍺","🥗",
      "🏠","🧾","🛠️","🪑","🤝",
      "🚗","⛽","🚆","🚲","✈️",
      "🩺","💊","🏥",
      "🎬","🎮","🎨","🎧","🎁","🎟️","🎁",
      "📚","🎓",
      "🔌","💡","📶","🖥️","💻","🧺",
      "🐶",
      "⛷️","🪩",
      "👕","👗","👟","💄","🧴",
      "🏖️","🧳","🛩️","🗺️",
      "📦","📬","📱",
      "⚽","🏋️","🧘","🚴",
    ] %}
    {% for em in emoji_list %}
      <button type="button" class="btn btn-light btn-sm emoji-btn" style="min-width:50px; padding:6px 8px;">{{ em }}</button>
    {% endfor %}
  </div>

  <div class="mt-2 text-muted small">Click emoji to paste into the selected field. ESC to close.</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  function editUrlFor(id) {
    // url_for('edit_category', cat_id=0) => e.g. "/categories/0/edit"
    // replace "/0/" with "/<id>/" to get the right endpoint
    return ("{{ url_for('edit_category', cat_id=0) }}").replace('/0/', '/' + encodeURIComponent(id) + '/');
  }

  // modal for adding keywords
  let keywordModal = null;
  if (typeof bootstrap !== 'undefined') {
    keywordModal = new bootstrap.Modal(document.getElementById('keywordModal'));
  }

  // ---------- KEYWORD BUTTONS ----------
  window.openKeywordModal = function(categoryId, categoryName) {
    if (!keywordModal) return;
    document.getElementById('keywordModalLabel').innerText = `Add keyword — ${categoryName}`;
    const form = document.getElementById('keyword-form');
    form.action = "{{ url_for('add_keyword', cat_id=0) }}".replace('/0/', '/' + encodeURIComponent(categoryId) + '/');
    document.getElementById('keyword-input').value = '';
    keywordModal.show();
  };

  document.querySelectorAll('.add-keyword-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const categoryId = this.dataset.catid;
      const categoryName = this.dataset.catname || '';
      openKeywordModal(categoryId, categoryName);
    });
  });

  // ---------- INLINE EDIT ----------
  const editState = {}; // id -> {originalName, originalEmoji}

  window.enterEdit = function(id) {
    const nameDisplay = document.getElementById(`name-display-${id}`);
    const nameInput = document.getElementById(`name-input-${id}`);
    const saveBtn = document.getElementById(`save-btn-${id}`);
    const cancelBtn = document.getElementById(`cancel-btn-${id}`);
    const emojiInput = document.getElementById(`emoji-input-${id}`);
    const emojiDisplay = document.getElementById(`emoji-display-${id}`);
    if (!nameDisplay || !nameInput) return;

    editState[id] = {
      originalName: nameDisplay.innerText.trim(),
      originalEmoji: (emojiInput && emojiInput.value) ? emojiInput.value : (emojiDisplay ? emojiDisplay.innerText.trim() : '')
    };

    nameDisplay.style.display = 'none';
    nameInput.style.display = 'block';
    nameInput.focus();
    if (saveBtn) saveBtn.style.display = 'inline-flex';
    if (cancelBtn) cancelBtn.style.display = 'inline-flex';
  };

  window.cancelEdit = function(id) {
    if (!editState[id]) return;
    const nameDisplay = document.getElementById(`name-display-${id}`);
    const nameInput = document.getElementById(`name-input-${id}`);
    const saveBtn = document.getElementById(`save-btn-${id}`);
    const cancelBtn = document.getElementById(`cancel-btn-${id}`);
    const emojiInput = document.getElementById(`emoji-input-${id}`);
    const emojiDisplay = document.getElementById(`emoji-display-${id}`);

    nameInput.value = editState[id].originalName;
    if (emojiInput) emojiInput.value = editState[id].originalEmoji || '';
    if (emojiDisplay) emojiDisplay.innerText = editState[id].originalEmoji || emojiDisplay.innerText;

    nameInput.style.display = 'none';
    nameDisplay.style.display = 'block';
    if (saveBtn) saveBtn.style.display = 'none';
    if (cancelBtn) cancelBtn.style.display = 'none';
    delete editState[id];
  };

  // Save: create a POST form and submit (keeps server-side redirect/flash behavior)
  window.saveEdit = function(id) {
    const nameInput = document.getElementById(`name-input-${id}`);
    const emojiInput = document.getElementById(`emoji-input-${id}`);
    if (!nameInput) return;
    const name = (nameInput.value || '').trim();
    const emoji = (emojiInput && emojiInput.value) ? emojiInput.value.trim() : '';

    if (!name) {
      nameInput.classList.add('is-invalid');
      setTimeout(()=>nameInput.classList.remove('is-invalid'), 1200);
      return;
    }

    const action = editUrlFor(id);
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = action;

    const inName = document.createElement('input'); inName.type = 'hidden'; inName.name = 'name'; inName.value = name;
    const inEmoji = document.createElement('input'); inEmoji.type = 'hidden'; inEmoji.name = 'emoji'; inEmoji.value = emoji;
    form.appendChild(inName);
    form.appendChild(inEmoji);

    document.body.appendChild(form);
    form.submit();
  };

  // ---------- EMOJI PANEL ----------
  let currentEmojiTarget = null; // the input element that will receive emoji
  const emojiPanel = document.getElementById('emoji-panel');
  const emojiButtons = document.querySelectorAll('.emoji-btn');

  window.openEmojiPanel = function(selector) {
    const el = (typeof selector === 'string') ? document.querySelector(selector) : selector;
    if (!el) return;
    currentEmojiTarget = el;
    if (emojiPanel) {
      emojiPanel.style.display = 'block';
      const search = document.getElementById('emoji-search');
      if (search) search.focus();
    }
  };

  function closeEmojiPanel() {
    if (!emojiPanel) return;
    emojiPanel.style.display = 'none';
    currentEmojiTarget = null;
    const search = document.getElementById('emoji-search');
    if (search) search.value = '';
    filterEmoji('');
  }

  emojiButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!currentEmojiTarget) {
        // flash to indicate "select a field first"
        if (emojiPanel) {
          emojiPanel.classList.add('border','border-warning');
          setTimeout(()=>emojiPanel.classList.remove('border','border-warning'), 700);
        }
        return;
      }

      const val = btn.innerText || btn.textContent;
      currentEmojiTarget.value = val;

      // If target is category hidden emoji input, update visible emoji display
      const tid = currentEmojiTarget.id || '';
      if (tid.startsWith('emoji-input-')) {
        const id = tid.replace('emoji-input-','');
        const display = document.getElementById(`emoji-display-${id}`);
        if (display) display.innerText = val;

        // If user isn't actively editing the category name, autosave the emoji immediately
        // (we need to POST name + emoji because server requires name field)
        if (!editState[id]) {
          // find current visible name
          const nameDisplay = document.getElementById(`name-display-${id}`);
          const currentName = nameDisplay ? nameDisplay.innerText.trim() : '';
          if (currentName) {
            // build form-data and send fetch POST (no redirect expected)
            try {
              const formData = new FormData();
              formData.append('name', currentName);
              formData.append('emoji', val);
              const resp = await fetch(editUrlFor(id), { method: 'POST', body: formData, headers: { 'Accept': 'application/json' }});
              // server currently returns redirect/HTML — we won't rely on JSON
              // on success we leave UI as-is; could show a small highlight.
              if (!resp.ok) {
                // brief visual feedback of failure
                display.classList.add('border','border-danger');
                setTimeout(()=>display.classList.remove('border','border-danger'), 1000);
              } else {
                // success highlight
                display.classList.add('border','border-success');
                setTimeout(()=>display.classList.remove('border','border-success'), 700);
              }
            } catch (err) {
              display.classList.add('border','border-danger');
              setTimeout(()=>display.classList.remove('border','border-danger'), 1000);
            }
          }
        }
      }

      closeEmojiPanel();
    });
  });

  // search/filter inside emoji panel
  const emojiSearch = document.getElementById('emoji-search');
  if (emojiSearch) emojiSearch.addEventListener('input', (ev) => filterEmoji(ev.target.value));

  function filterEmoji(q) {
    q = (q || '').trim().toLowerCase();
    document.querySelectorAll('#emoji-list .emoji-btn').forEach(b => {
      const txt = (b.innerText || b.textContent || '').toLowerCase();
      b.style.display = (!q || txt.includes(q)) ? 'inline-flex' : 'none';
    });
  }

  const closeBtn = document.getElementById('emoji-panel-close');
  if (closeBtn) closeBtn.addEventListener('click', closeEmojiPanel);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && emojiPanel && emojiPanel.style.display === 'block') closeEmojiPanel(); });

});
</script>

{% endblock %}
