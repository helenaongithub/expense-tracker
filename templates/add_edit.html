{% extends "base.html" %}
{% block content %}

{% if view_only %}
  <h3>Transaction #{{ tx['id'] if tx and 'id' in tx else '' }}</h3>

  <dl class="row">
    <dt class="col-sm-3">Date</dt><dd class="col-sm-9">{{ tx['date'] }}</dd>
    <dt class="col-sm-3">Description</dt><dd class="col-sm-9">{{ tx['description'] }}</dd>
    <dt class="col-sm-3">Amount</dt><dd class="col-sm-9">{{ tx['amount'] }}</dd>
    <dt class="col-sm-3">Category</dt><dd class="col-sm-9">{{ tx['category'] }}</dd>
  </dl>

  <a class="btn btn-secondary" href="{{ url_for('index') }}">Back</a>

{% else %}
  {# Single header for add OR edit #}
  <h3>{% if tx and tx.get('id') %}Edit transaction{% else %}Add transaction{% endif %}</h3>

  <form id="tx-form" method="post" novalidate>
    <input type="hidden" name="redirect_url" value="{{ redirect_url if redirect_url else request.referrer or url_for('index') }}">

    {% if errors and errors.get('general') %}
      <div class="alert alert-danger">{{ errors.get('general') }}</div>
    {% endif %}

    <div class="mb-3">
      <label for="date" class="form-label">Date</label>
      <input id="date" name="date"
             class="form-control {% if errors and errors.get('date') %}is-invalid{% endif %}"
             type="date" required
             value="{{ (form.date if form and (form.date|string).strip() else (tx.date if tx else today_date)) }}">
      {% if errors and errors.get('date') %}
        <div class="invalid-feedback">{{ errors.get('date') }}</div>
      {% else %}
        <div class="form-text">Accepted format: YYYY-MM-DD (defaults to today if left unchanged).</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">Description</label>
      <input id="description" name="description"
             class="form-control {% if errors and errors.get('description') %}is-invalid{% endif %}"
             value="{{ (form.description if form and (form.description|string).strip() else (tx.description if tx else '')) }}">
      {% if errors and errors.get('description') %}
        <div class="invalid-feedback">{{ errors.get('description') }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label for="amount" class="form-label">Amount</label>
      <input id="amount" name="amount" type="number" step="0.01"
             class="form-control {% if errors and errors.get('amount') %}is-invalid{% endif %}"
             value="{{ (form.amount if form and (form.amount|string).strip() else (tx.amount if tx else '')) }}">
      {% if errors and errors.get('amount') %}
        <div class="invalid-feedback">{{ errors.get('amount') }}</div>
      {% else %}
        <div class="form-text">Enter a positive number. For expenses, set Type = Expense.</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label for="category" class="form-label">Category</label>
      <input id="category" name="category"
             class="form-control {% if errors and errors.get('category') %}is-invalid{% endif %}"
             value="{{ (form.category if form and (form.category|string).strip() else (tx.category if tx else '')) }}">
      {% if errors and errors.get('category') %}
        <div class="invalid-feedback">{{ errors.get('category') }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label for="is_expense" class="form-label">Type</label>
      <select id="is_expense" name="is_expense" class="form-select {% if errors and errors.get('is_expense') %}is-invalid{% endif %}">
        <option value="1" {% if (form.is_expense if form else (tx.is_expense if tx else '1')) == '1' %}selected{% endif %}>Expense</option>
        <option value="0" {% if (form.is_expense if form else (tx.is_expense if tx else '0')) == '0' %}selected{% endif %}>Income</option>
      </select>
      {% if errors and errors.get('is_expense') %}
        <div class="invalid-feedback">{{ errors.get('is_expense') }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <button class="btn btn-primary" id="save-btn">Save</button>
      <a class="btn btn-secondary" href="{{ redirect_url or url_for('index') }}">Cancel</a>
    </div>
  </form>

  <!-- Client-side validation script -->
  <script>
    (function(){
      const form = document.getElementById('tx-form');
      if (!form) return;

      form.addEventListener('submit', function(e){
        // clear client-side previous invalid states
        form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        let hasError = false;

        // amount validation
        const amountInput = document.getElementById('amount');
        if (amountInput) {
          const val = amountInput.value.trim();
          if (val === '') {
            hasError = true;
            amountInput.classList.add('is-invalid');
            if (!amountInput.nextElementSibling || !amountInput.nextElementSibling.classList.contains('invalid-feedback')) {
              const msg = document.createElement('div');
              msg.className = 'invalid-feedback';
              msg.innerText = 'Amount is required.';
              amountInput.parentNode.appendChild(msg);
            }
          } else if (isNaN(val) || Number(val) <= 0) {
            hasError = true;
            amountInput.classList.add('is-invalid');
            if (!amountInput.nextElementSibling || !amountInput.nextElementSibling.classList.contains('invalid-feedback')) {
              const msg = document.createElement('div');
              msg.className = 'invalid-feedback';
              msg.innerText = 'Enter a positive number';
              amountInput.parentNode.appendChild(msg);
            }
          }
        }

        // date validation
        const dateInput = document.getElementById('date');
        if (dateInput) {
          const d = dateInput.value.trim();
          if (d !== '') {
            const re = /^\d{4}-\d{2}-\d{2}$/;
            if (!re.test(d)) {
              hasError = true;
              dateInput.classList.add('is-invalid');
              if (!dateInput.nextElementSibling || !dateInput.nextElementSibling.classList.contains('invalid-feedback')) {
                const msg = document.createElement('div');
                msg.className = 'invalid-feedback';
                msg.innerText = 'Use YYYY-MM-DD date format';
                dateInput.parentNode.appendChild(msg);
              }
            }
          } else {
            // allow empty â€” server will fill today_date if needed
          }
        }

        if (hasError) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
    })();
  </script>

{% endif %}
{% endblock %}
